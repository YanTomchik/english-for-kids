const cards = [ 
    ['Action Set (A)', 'Action Set (B)', 'Action Set (C)', 'Animal Set (A)', 'Animal Set (B)', 'Clothes', 'Emotions','Adjective'],
    [
      {
        word: 'cry',
        translation: 'плакать',
        image: 'img/cry.jpg',
        audioSrc: 'audio/cry.mp3'
      },
      {
        word: 'dance',
        translation: 'танцевать',
        image: 'img/dance.jpg',
        audioSrc: 'audio/dance.mp3'
      },
      {
        word: 'dive',
        translation: 'нырять',
        image: 'img/dive.jpg',
        audioSrc: 'audio/dive.mp3'
      },
      {
        word: 'draw',
        translation: 'рисовать',
        image: 'img/draw.jpg',
        audioSrc: 'audio/draw.mp3'
      },
      {
        word: 'fish',
        translation: 'ловить рыбу',
        image: 'img/fish.jpg',
        audioSrc: 'audio/fish.mp3'
      },
      {
        word: 'fly',
        translation: 'летать',
        image: 'img/fly.jpg',
        audioSrc: 'audio/fly.mp3'
      },
      {
        word: 'hug',
        translation: 'обнимать',
        image: 'img/hug.jpg',
        audioSrc: 'audio/hug.mp3'
      },
      {
        word: 'jump',
        translation: 'прыгать',
        image: 'img/jump.jpg',
        audioSrc: 'audio/jump.mp3'
      }
    ],
    [
      {
        word: 'open',
        translation: 'открывать',
        image: 'img/open.jpg',
        audioSrc: 'audio/open.mp3'
      },
      {
        word: 'play',
        translation: 'играть',
        image: 'img/play.jpg',
        audioSrc: 'audio/play.mp3'
      },
      {
        word: 'point',
        translation: 'указывать',
        image: 'img/point.jpg',
        audioSrc: 'audio/point.mp3'
      },
      {
        word: 'ride',
        translation: 'ездить',
        image: 'img/ride.jpg',
        audioSrc: 'audio/ride.mp3'
      },
      {
        word: 'run',
        translation: 'бегать',
        image: 'img/run.jpg',
        audioSrc: 'audio/run.mp3'
      },
      {
        word: 'sing',
        translation: 'петь',
        image: 'img/sing.jpg',
        audioSrc: 'audio/sing.mp3'
      },
      {
        word: 'skip',
        translation: 'пропускать, прыгать',
        image: 'img/skip.jpg',
        audioSrc: 'audio/skip.mp3'
      },
      {
        word: 'swim',
        translation: 'плавать',
        image: 'img/swim.jpg',
        audioSrc: 'audio/swim.mp3'
      }
    ],
    [
      {
        word: 'argue',
        translation: 'спорить',
        image: 'img/argue.jpg',
        audioSrc: 'audio/argue.mp3'
      },
      {
        word: 'build',
        translation: 'строить',
        image: 'img/build.jpg',
        audioSrc: 'audio/build.mp3'
      },
      {
        word: 'carry',
        translation: 'нести',
        image: 'img/carry.jpg',
        audioSrc: 'audio/carry.mp3'
      },
      {
        word: 'catch',
        translation: 'ловить',
        image: 'img/catch.jpg',
        audioSrc: 'audio/catch.mp3'
      },
      {
        word: 'drive',
        translation: 'водить машину',
        image: 'img/drive.jpg',
        audioSrc: 'audio/drive.mp3'
      },
      {
        word: 'drop',
        translation: 'падать',
        image: 'img/drop.jpg',
        audioSrc: 'audio/drop.mp3'
      },
      {
        word: 'pull',
        translation: 'тянуть',
        image: 'img/pull.jpg',
        audioSrc: 'audio/pull.mp3'
      },
      {
        word: 'push',
        translation: 'толкать',
        image: 'img/push.jpg',
        audioSrc: 'audio/push.mp3'
      }
    ],
    [
      {
        word: 'cat',
        translation: 'кот',
        image: 'img/cat.jpg',
        audioSrc: 'audio/cat.mp3'
      },
      {
        word: 'chick',
        translation: 'цыплёнок',
        image: 'img/chick.jpg',
        audioSrc: 'audio/chick.mp3'
      },
      {
        word: 'chicken',
        translation: 'курица',
        image: 'img/chicken.jpg',
        audioSrc: 'audio/chicken.mp3'
      },
      {
        word: 'dog',
        translation: 'собака',
        image: 'img/dog.jpg',
        audioSrc: 'audio/dog.mp3'
      },
      {
        word: 'horse',
        translation: 'лошадь',
        image: 'img/horse.jpg',
        audioSrc: 'audio/horse.mp3'
      },
      {
        word: 'pig',
        translation: 'свинья',
        image: 'img/pig.jpg',
        audioSrc: 'audio/pig.mp3'
      },
      {
        word: 'rabbit',
        translation: 'кролик',
        image: 'img/rabbit.jpg',
        audioSrc: 'audio/rabbit.mp3'
      },
      {
        word: 'sheep',
        translation: 'овца',
        image: 'img/sheep.jpg',
        audioSrc: 'audio/sheep.mp3'
      }
    ],
    [
      {
        word: 'bird',
        translation: 'птица',
        image: 'img/bird.jpg',
        audioSrc: 'audio/bird.mp3'
      },
      {
        word: 'fish',
        translation: 'рыба',
        image: 'img/fish1.jpg',
        audioSrc: 'audio/fish.mp3'
      },
      {
        word: 'frog',
        translation: 'жаба',
        image: 'img/frog.jpg',
        audioSrc: 'audio/frog.mp3'
      },
      {
        word: 'giraffe',
        translation: 'жирафа',
        image: 'img/giraffe.jpg',
        audioSrc: 'audio/giraffe.mp3'
      },
      {
        word: 'lion',
        translation: 'лев',
        image: 'img/lion.jpg',
        audioSrc: 'audio/lion.mp3'
      },
      {
        word: 'mouse',
        translation: 'мышь',
        image: 'img/mouse.jpg',
        audioSrc: 'audio/mouse.mp3'
      },
      {
        word: 'turtle',
        translation: 'черепаха',
        image: 'img/turtle.jpg',
        audioSrc: 'audio/turtle.mp3'
      },
      {
        word: 'dolphin',
        translation: 'дельфин',
        image: 'img/dolphin.jpg',
        audioSrc: 'audio/dolphin.mp3'
      }
    ],
    [
      {
        word: 'skirt',
        translation: 'юбка',
        image: 'img/skirt.jpg',
        audioSrc: 'audio/skirt.mp3'
      },
      {
        word: 'pants',
        translation: 'брюки',
        image: 'img/pants.jpg',
        audioSrc: 'audio/pants.mp3'
      },
      {
        word: 'blouse',
        translation: 'блузка',
        image: 'img/blouse.jpg',
        audioSrc: 'audio/blouse.mp3'
      },
      {
        word: 'dress',
        translation: 'платье',
        image: 'img/dress.jpg',
        audioSrc: 'audio/dress.mp3'
      },
      {
        word: 'boot',
        translation: 'ботинок',
        image: 'img/boot.jpg',
        audioSrc: 'audio/boot.mp3'
      },
      {
        word: 'shirt',
        translation: 'рубашка',
        image: 'img/shirt.jpg',
        audioSrc: 'audio/shirt.mp3'
      },
      {
        word: 'coat',
        translation: 'пальто',
        image: 'img/coat.jpg',
        audioSrc: 'audio/coat.mp3'
      },
      {
        word: 'shoe',
        translation: 'туфли',
        image: 'img/shoe.jpg',
        audioSrc: 'audio/shoe.mp3'
      }
    ],
    [
      {
        word: 'sad',
        translation: 'грустный',
        image: 'img/sad.jpg',
        audioSrc: 'audio/sad.mp3'
      },
      {
        word: 'angry',
        translation: 'сердитый',
        image: 'img/angry.jpg',
        audioSrc: 'audio/angry.mp3'
      },
      {
        word: 'happy',
        translation: 'счастливый',
        image: 'img/happy.jpg',
        audioSrc: 'audio/happy.mp3'
      },
      {
        word: 'tired',
        translation: 'уставший',
        image: 'img/tired.jpg',
        audioSrc: 'audio/tired.mp3'
      },
      {
        word: 'surprised',
        translation: 'удивлённый',
        image: 'img/surprised.jpg',
        audioSrc: 'audio/surprised.mp3'
      },
      {
        word: 'scared',
        translation: 'испуганный',
        image: 'img/scared.jpg',
        audioSrc: 'audio/scared.mp3'
      },
      {
        word: 'smile',
        translation: 'улыбка',
        image: 'img/smile.jpg',
        audioSrc: 'audio/smile.mp3'
      },
      {
        word: 'laugh',
        translation: 'смех',
        image: 'img/laugh.jpg',
        audioSrc: 'audio/laugh.mp3'
      }
    ],
    [
      {
        word: 'big',
        translation: 'большой',
        image: 'img/big.jpg',
        audioSrc: 'audio/big.mp3'
      },
      {
        word: 'small',
        translation: 'маленький',
        image: 'img/small.jpg',
        audioSrc: 'audio/small.mp3'
      },
      {
        word: 'fast',
        translation: 'быстрый',
        image: 'img/fast.jpg',
        audioSrc: 'audio/fast.mp3'
      },
      {
        word: 'slow',
        translation: 'медленный',
        image: 'img/slow.jpg',
        audioSrc: 'audio/slow.mp3'
      },
      {
        word: 'friendly',
        translation: 'дружелюбный',
        image: 'img/friendly.jpg',
        audioSrc: 'audio/friendly.mp3'
      },
      {
        word: 'unfriendly',
        translation: 'недружелюбный',
        image: 'img/unfriendly.jpg',
        audioSrc: 'audio/unfriendly.mp3'
      },
      {
        word: 'young',
        translation: 'молодой',
        image: 'img/young.jpg',
        audioSrc: 'audio/young.mp3'
      },
      {
        word: 'old',
        translation: 'старый',
        image: 'img/old.jpg',
        audioSrc: 'audio/old.mp3'
      }  
    ]
  ]
const category_images = ["actions1", "actions2", "actions3", "animals1", "animals2", "clothes", "emotions", "ajective"];

const MODES = {
  train: 'train',
  play: 'play'
};

const PAGES = {
  category: 'category',
  cards: 'cards',
};

let mode = MODES.train;
let current_page = PAGES.category;
let current_category = 1;

const toggle = document.getElementById('switchBtn');
toggle.addEventListener('change', changeMode);

const player = document.getElementById('player');
const player_results = document.getElementById('player_results');

const menu = document.getElementById('menu');
menu.addEventListener("mouseleave", onMenuMouseLeave);
menu.innerHTML = fillMenuList();

const gamb = document.getElementById('gamb');
const stars = document.getElementById('stars');
const cards_container = document.getElementById('cards_container');
const success_failure = document.getElementById('success_failure');

function onMenuMouseLeave() {
  gamb.checked = false;
}
 
function fillMenuList() {
  let htmlCode = `<li><a class="active" href="#main">Main page</a></li>`;
  for(let i = 0; i < cards[0].length; i++) {
    htmlCode += `<li><a href="#cards" data-catnr="` + (i + 1) + `">` + cards[0][i] + `</a></li>`;
  }
  return htmlCode;    
}

for(let i = 0; i < menu.childNodes.length; i++) menu.childNodes[i].addEventListener('click', (event) => onMenuClick(event));

function onMenuClick(evt) {
  let obj = evt.currentTarget;
  let path = obj.children[0].href;
  let pos = path.indexOf('#');//первый индекс, по которому данный элемент может быть найден 
  let link = path.substring(pos+1);//берем подстроку начиная с #
  let menu_items = menu.childNodes;
  for(let i = 0; i < menu_items.length; i++) menu_items[i].firstElementChild.classList.remove("active");
  switch(link) {
    case 'main':
      menu.firstChild.firstElementChild.classList.add('active');    
      createCategoryCards();
      break;
    case 'cards':
      current_category = parseInt(obj.children[0].dataset.catnr);
      current_page = PAGES.cards;
      menu_items[current_category].firstElementChild.classList.add('active');
      createWordCards();
      break;
  }
  gamb.checked = false;
}


const caption = document.getElementById("caption");
caption.innerText="Categories";
const cardsList = document.getElementById('cards');
createCategoryCards();
const btnStartGame = document.getElementById('game');
btnStartGame.addEventListener('click', onStartGame);


function createCategoryCards() {
  caption.innerText="Categories";
  cards_container.style.display = "block";
  let htmlcode = "";
  for(let i = 0; i < cards[0].length; i++) {
    htmlcode +=`<div class="category_card" data-catnr="` + (i + 1) + `">` +
      `<div class="category_card_background">` + 
      `<div class="category_class_image" style="background-image:url('./img/` + category_images[i] + `.jpg')">` +
      `</div></div><div class="category_card_caption_container">` + 
      `<p class="category_card_caption">` + cards[0][i] + `</p></div></div>`;
  }
  cardsList.innerHTML = htmlcode;
  let children = cardsList.childNodes;
  for(let i = 0; i < children.length; i++ ) {
    children[i].addEventListener('click', (event) => onCategoryCardClick(event));
  }  
}

function onCategoryCardClick(evt) {
  current_category = parseInt(evt.currentTarget.dataset.catnr);
  current_page = PAGES.cards;
  createWordCards();
}

function createWordCards() {
  cards_container.style.display = "block";
   caption.innerText = cards[0][current_category-1];
  
  if(mode == MODES.play) {
    cardsList.innerHTML = createWordsPlayHTML(current_category);
    btnStartGame.style.display = "block";
  }
  else {
    cardsList.innerHTML = createWordsTrainHTML(current_category);
    btnStartGame.style.display = "none";
    let btns = document.querySelectorAll('#cards button');
    for(let i = 0; i <btns.length; i++) {
      btns[i].addEventListener('click', (event) => onBtnRotateClick(event));
      cardsList.children[i].children[0].addEventListener('click', (event) => onClickTrainCard(event));
    }    
  }
}

function onClickTrainCard(evt) {
  if(evt.target.parentElement.tagName != "BUTTON") {
    let obj = evt.currentTarget;
    let word = obj.children[0].children[1].innerText;
    let word_info = findWordInfo(word, current_category);
    playSound(word_info.audioSrc);   
  }
}

function onBtnRotateClick(evt) {
  let front_card = evt.currentTarget.parentElement.parentNode.parentElement;
  let back_card = evt.currentTarget.parentElement.parentNode.parentElement.nextElementSibling;
  front_card.classList.add("front_rotate");
  back_card.classList.add("back_rotate");
  back_card.addEventListener('mouseleave', onMouseLeave);
}

function changeMode() {
  if(mode == MODES.train) mode = MODES.play;
  else mode = MODES.train;
  if(current_page == PAGES.cards)
    createWordCards(); 
}

function onMouseLeave(evt) {
  let front_card = evt.currentTarget.previousElementSibling;
  let back_card = evt.currentTarget;  
  front_card.classList.remove("front_rotate");
  back_card.classList.remove("back_rotate");
  back_card.removeEventListener('mouseleave', onMouseLeave);
}

function createWordsPlayHTML(catNr) {
  let htmlCode = ""; 
  for(let i = 0; i< cards[catNr].length; i++ ) {
    htmlCode += `<div class = "card_play" data-word="` + cards[catNr][i].word + `" style="background-image:url('./` + cards[catNr][i].image + `')"></div>`;
  } 
  return htmlCode;
}

function createWordsTrainHTML(catNr) {
  let htmlCode = ""; 
  for(let i = 0; i< cards[catNr].length; i++ ) {
    htmlCode += `<div class="card"><div class="front"><div class="word_english">` +
  `<div class="word_image" style="background-image:url('./` + cards[catNr][i].image + `')"></div>` + 
  `<div class="word_caption"><p>` + cards[catNr][i].word + `</p><button><img src="./img/rotate.svg"/></button>` + 
  `</div></div></div><div class="back"><div class="word_russian">` +
  `<div class="word_image" style="background-image:url('./` + cards[catNr][i].image + `')"></div>` +
   `<div class="word_caption"><p>` + cards[catNr][i].translation + `</p></div></div></div></div>`;
  } 
  return htmlCode;
}

let randomArray = [];

let errors = 0;
let common_errors = 0;

function onStartGame(evt) {
  errors = 0;
  randomArray = generateRandomArray(8);
  //меняем кнопку Start на Repeat
  evt.target.style.backgroundColor = "#f7aa47";
  evt.target.innerHTML = "Repeat word";
  evt.target.removeEventListener('click', onStartGame);
  evt.target.addEventListener('click', onRepeatWordClick);
  let child = cardsList.childNodes;
  for(let i = 0; i < child.length; i++) child[i].addEventListener('click', (event) => guessWord(event));
  let src = cards[current_category][randomArray[0]-1].audioSrc;
  playSound(src);
}

function onRepeatWordClick() {
  let src = cards[current_category][randomArray[0]-1].audioSrc;
  playSound(src);
}

function guessWord(evt) {
  if(evt.target.classList.contains('disabled') == true) return;
  
  if(evt.target.dataset.word == cards[current_category][randomArray[0]-1].word) { //слово угадано     
    stars.innerHTML = `<div class="star correct"></div>` + stars.innerHTML;
    evt.target.classList.add('disabled');

    //играет одобряющий сигнал
    playResults("audio/correct.mp3");
    
    //если есть еще слова,играем дальше
    if(randomArray.length > 1) {
      randomArray.shift();
      errors = 0;
      setTimeout(playNextWord, 1000);    
    }
    
    //слов больше нет
    else {
      if(common_errors == 0 ) {        
        //играет success.mp3
        setTimeout(playSuccess, 1000);
        setTimeout(showSuccess, 1000);        
      }
      else {
        //играет failure.mp3
        setTimeout(playFailure, 1000);
        setTimeout(showFailure, 1000);        
      }
      errors = 0;      
      stars.innerHTML = "";      

      btnStartGame.removeEventListener('click', onRepeatWordClick);      
      btnStartGame.addEventListener('click', onStartGame);
      btnStartGame.style.display = "none";
      btnStartGame.style.backgroundColor = "#003c6f";
      btnStartGame.innerHTML = "Start game";
      
      let menu_items = menu.childNodes;
      for(let i = 0; i < menu_items.length; i++) menu_items[i].firstElementChild.classList.remove("active");
      menu.firstChild.firstElementChild.classList.add('active');
      
      setTimeout(retuntToCategory, 5000);
    }
  }
  else {
    //выдает звук error.mp3
    errors++;
    common_errors++;
    playResults("audio/error.mp3");
    stars.innerHTML = `<div class="star error"></div>` + stars.innerHTML;    
  }
}

function showSuccess() {
  createSmile(true);
}

function showFailure() {
  createSmile(false);
}

function createSmile(success) {
  let h_text = "";
  let src = "";
  if(success == true) {
    h_text = "You win!";
    src = "./img/success.jpg";
  }
  else {
    h_text = (common_errors > 1) ? common_errors + "errors" : "1 error";
    src = "./img/failure.jpg";
  }
  success_failure.innerHTML = `<h1 class="caption">` + h_text + `</h1><img src="` + src + `" alt="reaction" />`;
  success_failure.style.display = "block";
  common_errors = 0;
  setTimeout(closeReaction, 5000);
}

function closeReaction() {
  success_failure.style.display = "none";
}

function retuntToCategory() {
  createCategoryCards();
}

function playSuccess() {
  player_results.src = "./audio/success.mp3";
  player_results.play();
}

function playFailure() {
  player_results.src = "./audio/failure.mp3";
  player_results.play();
}

function playNextWord() {
  let src = cards[current_category][randomArray[0]-1].audioSrc;    
  playSound(src);    
}
 
function playSound(src) {
  player.src = "./" + src;
  player.play();
}

function playResults(src) {
  player_results.src = "./" + src;
  player_results.play();
}

function findWordInfo(word, category) {
  let arr = cards[category];  
  for(let i = 0; i < arr.length; i++) {
    if(arr[i].word == word) return cards[category][i];
  }
  return null;
}

function generateRandomArray(n) {
  let num_array = [];
  let rand_array = [];
  for(let i = 1; i <= n; i++) {
    num_array.push(i);
  }//заполняем массив числами до n
  while(num_array.length != 0) {
    let rand = Math.ceil((Math.random() * num_array.length))-1;
    rand_array.push(num_array[rand]);
     num_array.splice(rand, 1);//удаляем элемент по индексу rand
  }
  return rand_array;
}

           
  
